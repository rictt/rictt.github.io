<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>什么是Fiber | 狗子的博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="记录生活，记录bug!">
    
    <link rel="preload" href="/assets/css/0.styles.2d7509d5.css" as="style"><link rel="preload" href="/assets/js/app.bb8cb600.js" as="script"><link rel="preload" href="/assets/js/11.a3791431.js" as="script"><link rel="preload" href="/assets/js/24.cb4ed996.js" as="script"><link rel="prefetch" href="/assets/js/1.22b784aa.js"><link rel="prefetch" href="/assets/js/12.6261f5b4.js"><link rel="prefetch" href="/assets/js/13.86a047ff.js"><link rel="prefetch" href="/assets/js/14.7953b57d.js"><link rel="prefetch" href="/assets/js/15.1ecae33c.js"><link rel="prefetch" href="/assets/js/16.c06b96a9.js"><link rel="prefetch" href="/assets/js/17.aea8c476.js"><link rel="prefetch" href="/assets/js/18.2ddb3342.js"><link rel="prefetch" href="/assets/js/19.46105c6c.js"><link rel="prefetch" href="/assets/js/2.7524170b.js"><link rel="prefetch" href="/assets/js/20.21d391f0.js"><link rel="prefetch" href="/assets/js/21.01f8e774.js"><link rel="prefetch" href="/assets/js/22.d82de8e2.js"><link rel="prefetch" href="/assets/js/23.c902bd4c.js"><link rel="prefetch" href="/assets/js/25.06f23009.js"><link rel="prefetch" href="/assets/js/26.6a416950.js"><link rel="prefetch" href="/assets/js/27.f239f8b2.js"><link rel="prefetch" href="/assets/js/28.e6595db8.js"><link rel="prefetch" href="/assets/js/29.2499de18.js"><link rel="prefetch" href="/assets/js/3.c13987f3.js"><link rel="prefetch" href="/assets/js/30.ec2771a3.js"><link rel="prefetch" href="/assets/js/31.cab925d7.js"><link rel="prefetch" href="/assets/js/32.aaba9d6b.js"><link rel="prefetch" href="/assets/js/33.4dede3ae.js"><link rel="prefetch" href="/assets/js/34.e108cd73.js"><link rel="prefetch" href="/assets/js/35.31dd9db1.js"><link rel="prefetch" href="/assets/js/36.35a96604.js"><link rel="prefetch" href="/assets/js/37.ccd32209.js"><link rel="prefetch" href="/assets/js/38.767cc5f3.js"><link rel="prefetch" href="/assets/js/39.7ed8889b.js"><link rel="prefetch" href="/assets/js/4.7abd0e8e.js"><link rel="prefetch" href="/assets/js/40.d35c39ec.js"><link rel="prefetch" href="/assets/js/41.844b41da.js"><link rel="prefetch" href="/assets/js/42.f0c77d2b.js"><link rel="prefetch" href="/assets/js/43.fafef18f.js"><link rel="prefetch" href="/assets/js/44.3821eb8f.js"><link rel="prefetch" href="/assets/js/45.0585464f.js"><link rel="prefetch" href="/assets/js/46.1f77f027.js"><link rel="prefetch" href="/assets/js/47.f47808a4.js"><link rel="prefetch" href="/assets/js/48.dbaed69f.js"><link rel="prefetch" href="/assets/js/49.0859a6e0.js"><link rel="prefetch" href="/assets/js/5.dc5a5f90.js"><link rel="prefetch" href="/assets/js/50.cb3a8f5b.js"><link rel="prefetch" href="/assets/js/51.0b6551a0.js"><link rel="prefetch" href="/assets/js/52.ad422568.js"><link rel="prefetch" href="/assets/js/53.92cb68e0.js"><link rel="prefetch" href="/assets/js/54.f83681f3.js"><link rel="prefetch" href="/assets/js/55.0267d285.js"><link rel="prefetch" href="/assets/js/56.a82dbeec.js"><link rel="prefetch" href="/assets/js/57.ba4f8ea5.js"><link rel="prefetch" href="/assets/js/58.384dc386.js"><link rel="prefetch" href="/assets/js/59.04682dac.js"><link rel="prefetch" href="/assets/js/6.e5a57202.js"><link rel="prefetch" href="/assets/js/60.4f7c43ab.js"><link rel="prefetch" href="/assets/js/61.85cfacbf.js"><link rel="prefetch" href="/assets/js/62.cddefb27.js"><link rel="prefetch" href="/assets/js/63.867189ef.js"><link rel="prefetch" href="/assets/js/64.ab1ec420.js"><link rel="prefetch" href="/assets/js/65.35c96559.js"><link rel="prefetch" href="/assets/js/66.b256f951.js"><link rel="prefetch" href="/assets/js/67.ddb92cad.js"><link rel="prefetch" href="/assets/js/68.0860b2f0.js"><link rel="prefetch" href="/assets/js/69.58b713c5.js"><link rel="prefetch" href="/assets/js/7.d65eb7e3.js"><link rel="prefetch" href="/assets/js/70.001ed193.js"><link rel="prefetch" href="/assets/js/71.632935b7.js"><link rel="prefetch" href="/assets/js/72.ed6347bf.js"><link rel="prefetch" href="/assets/js/73.1ef8eae4.js"><link rel="prefetch" href="/assets/js/74.334f3694.js"><link rel="prefetch" href="/assets/js/75.b9dd2ad8.js"><link rel="prefetch" href="/assets/js/76.8bef6b4f.js"><link rel="prefetch" href="/assets/js/8.44a6ebd7.js"><link rel="prefetch" href="/assets/js/9.391e332d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2d7509d5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="狗子的博客" class="logo"> <span class="site-name can-hide">狗子的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/canvas/" class="sidebar-heading clickable"><span>canvas</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/css/" class="sidebar-link">css</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/javascript/" class="sidebar-heading clickable"><span>javascript</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/react/" class="sidebar-heading clickable router-link-active open"><span>react</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/Fiber.html" aria-current="page" class="active sidebar-link">Fiber</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/Fiber.html#什么是fiber" class="sidebar-link">什么是Fiber</a></li><li class="sidebar-sub-header"><a href="/react/Fiber.html#为什么提出了fiber-都做了些什么" class="sidebar-link">为什么提出了Fiber，都做了些什么</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/Fiber.html#stack-reconcilation-基于栈的协调算法" class="sidebar-link">Stack Reconcilation（基于栈的协调算法）</a></li><li class="sidebar-sub-header"><a href="/react/Fiber.html#fiber-reconcilation-fiber协调算法" class="sidebar-link">Fiber Reconcilation（Fiber协调算法）</a></li></ul></li></ul></li><li><a href="/react/Hooks原理.html" class="sidebar-link">Hooks原理</a></li><li><a href="/react/KeepAlive.html" class="sidebar-link">KeepAlive</a></li><li><a href="/react/aHooks使用.html" class="sidebar-link">aHooks使用</a></li><li><a href="/react/事件系统.html" class="sidebar-link">事件系统</a></li><li><a href="/react/受控与非受控组件.html" class="sidebar-link">受控与非受控组件</a></li></ul></section></li><li><a href="/resume/" class="sidebar-link">resume</a></li><li><a href="/vue/" class="sidebar-link">vue</a></li><li><a href="/webpack/" class="sidebar-link">webpack</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/代码检查和风格/" class="sidebar-heading clickable"><span>代码检查和风格</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/包管理器/" class="sidebar-heading clickable"><span>包管理器</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/存档/" class="sidebar-heading clickable"><span>存档</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/打包工具/" class="sidebar-heading clickable"><span>打包工具</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/浏览器插件/" class="sidebar-heading clickable"><span>浏览器插件</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="什么是fiber"><a href="#什么是fiber" class="header-anchor">#</a> 什么是Fiber</h2> <p>Fiber是React团队用来描述dom节点以及vnode节点的数据结构层，可以理解为两者的桥梁；</p> <p>从数据结构上，Fiber是对节点新的描述结构；</p> <p>我们都知道我们写的jsx最终都会经过babel编译，转换成React.CreateElement最后变成ReactElement，该ele保存了jsx对应的信息，并且创建一个FiberNode绑定上；如下</p> <p><img src="/assets/img/react-element.6c5b1b86.png" alt=""></p> <p>为什么需要这个桥梁，首先分层可以将工作的粒度分小，并且分工明确；React依赖这三层去做节点更新；哪三层呢</p> <ul><li>reactelement节点层（vnode层）</li> <li>fiber节点层</li> <li>dom节点层</li></ul> <p>如果把对应层的工具具体一点说，可以想象如下</p> <ul><li>setState({ a: 123 })</li> <li>找到setState的组件fiber节点，从该节点开始遍历子节点兄弟节点，找到需要更新的fiber</li> <li>更新fiber对应的dom节点</li></ul> <p>从更新协调上，Fiber是对节点更新新的协调算法；（下文说）</p> <p>从计算机操作系统上，Fiber对应纤维；操作系统上进程是最小可分配的单元，线程是最小可调度的单元，而Fiber是更小的一个单元，在react当中，fiber实际上作为每次任务的执行最小工作，也是贴切的叫法；</p> <p><strong>小结：什么是Fiber，Fiber可以理解为 = Fiber数据结构 + Fiber协调算法；</strong></p> <hr> <h2 id="为什么提出了fiber-都做了些什么"><a href="#为什么提出了fiber-都做了些什么" class="header-anchor">#</a> 为什么提出了Fiber，都做了些什么</h2> <h3 id="stack-reconcilation-基于栈的协调算法"><a href="#stack-reconcilation-基于栈的协调算法" class="header-anchor">#</a> Stack Reconcilation（基于栈的协调算法）</h3> <p>首先react16之前的架构主要是基于栈结构去更新渲染的，16之后才是Fiber；我们都知道html结构是天然的嵌套结构，很适合用栈来进行管理；基于此16之前的架构也是用栈来进行保存节点，然后更新；有特点，实现简单；但同样也导致了其他问题</p> <p><strong>首先是特点</strong></p> <ul><li>数据结构简单（栈结构保存）</li> <li>协调算法简单（栈递归就完事了）</li> <li>同步、递归执行/更新</li></ul> <p><strong>缺点</strong></p> <ul><li>节点层次太深，每次更新一个state，都要从根节点去递归找到需要更新的节点（内存占用高，层次深）</li> <li>堵塞渲染进程，js进程和浏览器渲染进程是互斥的，同时只能存在一个
<ul><li><p>这也就导致了不能够让出主线程，等待下一次执行（保存更新节点信息代价大）；</p> <p>栈结构的问题，每个栈元素只能够访问到当前及children的信息；由于我们的遍历算法是DFS，当需要暂停的时候，要想恢复我们需要保存父亲节点以及其他兄弟节点；当节点够多时，内存占用消耗极大</p></li></ul></li></ul> <h3 id="fiber-reconcilation-fiber协调算法"><a href="#fiber-reconcilation-fiber协调算法" class="header-anchor">#</a> Fiber Reconcilation（Fiber协调算法）</h3> <p>针对上面的缺点，堵塞主线程 + 不支持暂停等缺点；React团队提出了新的架构</p> <p>首先是新的数据结构Fiber，用链表来保存每个节点信息，分别通过<code>return</code>、<code>sibling</code>、<code>child</code>来执行兄弟姐妹父亲；</p> <ul><li>return指向父亲节点</li> <li>sibling指向兄弟节点</li> <li>child指向<code>第一个</code>子节点</li></ul> <p>其次是协调算法，类似DFS（深度搜索优先），执行完当前Fiber节点比较</p> <ul><li>1、执行完当前Fiber节点比较</li> <li>2、执行child节点比较
<ul><li>2.1、如果有child节点，重复顺序1</li> <li>2.2、如果没有child节点，返回找兄弟节点</li></ul></li> <li>3、执行兄弟节点
<ul><li>3.1、如果有，重复顺序1</li> <li>3.2、如果没有，返回父亲节点</li></ul></li></ul> <p><strong>新架构优点</strong></p> <ul><li>异步更新（不堵塞主线程，可以根据情况所有权）</li> <li>可以暂停恢复</li></ul> <h4 id="为什么可以异步更新"><a href="#为什么可以异步更新" class="header-anchor">#</a> 为什么可以异步更新</h4> <p>首先你知道显示器帧率/赫兹吧，一般都是60，也有120；代表什么意思呢：显示器一秒钟绘制60/120次，也就是每16毫秒进行绘制内容（1000/60）；</p> <p>浏览器也是一样，浏览器绘制顺序包括</p> <ul><li>xxxx</li> <li>js执行</li> <li>style绘制</li> <li>layout生成</li> <li>paint绘制</li> <li>合成</li></ul> <p>也就是说16ms我们要完成上面这么多的事情；如果我们的更新任务太多时间太长，就会占据js执行的很大部分时间，从而影响用户体验（卡顿）；</p> <p>所以react内部设置了每次调度的执行时间（大概5ms），超过这个时间就停止执行任务；等待下一次的循环再执行任务（基于MessageChannel）；</p> <p>所以我们说是异步的</p> <h4 id="为什么这种协调算法就能实现暂停"><a href="#为什么这种协调算法就能实现暂停" class="header-anchor">#</a> 为什么这种协调算法就能实现暂停</h4> <p>首先当我们有高优先级的任务或者协调算法执行瞬间不够的时候，我们将当前Fiber节点保存起来（占用一个内存）；当有新的执行时间可以执行任务时，找到这个节点，通过<code>return</code>、<code>sibling</code>、<code>child</code>就实现了恢复（代价比较低）</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/javascript/正则整理.html" class="prev">
        正则整理
      </a></span> <span class="next"><a href="/react/Hooks原理.html">
        Hooks原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bb8cb600.js" defer></script><script src="/assets/js/11.a3791431.js" defer></script><script src="/assets/js/24.cb4ed996.js" defer></script>
  </body>
</html>
